<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像背景切り抜きツール (ブラウザ版)</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        input[type="file"] { display: block; margin: 15px auto; }
        button {
            display: block; margin: 10px auto; padding: 10px 20px; font-size: 16px;
            cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px;
        }
        button:disabled { background-color: #ccc; }
        .image-container { display: flex; justify-content: space-around; margin-top: 20px; flex-wrap: wrap; }
        .image-box { border: 1px solid #ccc; padding: 10px; margin:10px; width: calc(50% - 42px); min-width: 250px; box-sizing: border-box;}
        .image-box h2 { font-size: 1em; text-align: center; margin-bottom: 10px;}
        img { max-width: 100%; max-height: 300px; display: block; margin: 0 auto; }
        #loading { display: none; text-align: center; margin-top: 15px; font-weight: bold; }
        #downloadLink {
            display: none; margin: 15px auto; padding: 10px 20px; background-color: #28a745; color: white;
            text-decoration: none; border-radius: 5px; text-align: center; width: fit-content;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>画像背景切り抜きツール (ブラウザ版)</h1>
        <p style="text-align:center;">背景を切り取りたい画像を選択してください。</p>
        <input type="file" id="imageUpload" accept="image/*">

        <!-- ▼ ここからが前回ご要望の、全体画像から一部分を切り抜く処理を追加する部分 ▼ -->
        <fieldset style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px;">
            <legend>オプション: スクリーンショットからアイテム領域を切り抜く</legend>
            <p style="font-size: 0.9em; color: #555;">
                ゲームのスクリーンショット全体をアップロードした場合、ここをチェックして切り抜く座標を指定してください。<br>
                (左上のX, 左上のY, 幅, 高さ) の形式で入力します。
            </p>
            <input type="checkbox" id="enableCrop">
            <label for="enableCrop">指定範囲を切り抜いてから背景除去する</label><br>
            <div id="cropSettings" style="display:none; margin-top:10px;">
                X: <input type="number" id="cropX" placeholder="例: 780" style="width:60px;">
                Y: <input type="number" id="cropY" placeholder="例: 85" style="width:60px;"><br>
                幅: <input type="number" id="cropWidth" placeholder="例: 425" style="width:60px;">
                高さ: <input type="number" id="cropHeight" placeholder="例: 320" style="width:60px;">
            </div>
        </fieldset>
        <!-- ▲ ここまでが追加部分 ▲ -->

        <button id="processImageBtn">背景を切り抜く</button>
        <p id="loading">処理中...</p>

        <div class="image-container">
            <div class="image-box">
                <h2>元画像 (または切り抜き後)</h2>
                <img id="originalImagePreview" src="#" alt="元画像">
            </div>
            <div class="image-box">
                <h2>背景切り抜き後</h2>
                <img id="resultImage" src="#" alt="切り抜き後の画像">
            </div>
        </div>
        <a id="downloadLink" href="#" download="background_removed_image.png">画像をダウンロード</a>
    </div>

    <!-- @picflow/background-removal ライブラリをCDNから読み込み -->
    <script type="module">
        // ES Moduleとしてライブラリをインポート
        import { removeBackground } from 'https://cdn.jsdelivr.net/npm/@picflow/background-removal@latest/dist/index.esm.js';

        const imageUpload = document.getElementById('imageUpload');
        const originalImagePreview = document.getElementById('originalImagePreview');
        const resultImage = document.getElementById('resultImage');
        const processImageBtn = document.getElementById('processImageBtn');
        const loadingText = document.getElementById('loading');
        const downloadLink = document.getElementById('downloadLink');

        // ▼ここからが追加部分の要素取得▼
        const enableCropCheckbox = document.getElementById('enableCrop');
        const cropSettingsDiv = document.getElementById('cropSettings');
        const cropXInput = document.getElementById('cropX');
        const cropYInput = document.getElementById('cropY');
        const cropWidthInput = document.getElementById('cropWidth');
        const cropHeightInput = document.getElementById('cropHeight');
        // ▲ここまでが追加部分の要素取得▲


        let currentFile = null;
        let imageToProcess = null; // 背景除去処理対象の画像データ (BlobまたはFile)

        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                currentFile = file;
                imageToProcess = file; // 初期状態ではアップロードされたファイルそのもの
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImagePreview.src = e.target.result;
                    originalImagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);

                resultImage.src = "#";
                resultImage.style.display = 'none';
                downloadLink.style.display = 'none';
            }
        });

        // ▼ここからが追加部分のイベントリスナー▼
        enableCropCheckbox.addEventListener('change', () => {
            cropSettingsDiv.style.display = enableCropCheckbox.checked ? 'block' : 'none';
        });
        // ▲ここまでが追加部分のイベントリスナー▲


        processImageBtn.addEventListener('click', async () => {
            if (!currentFile) {
                alert('まず画像を選択してください。');
                return;
            }

            loadingText.style.display = 'block';
            processImageBtn.disabled = true;
            resultImage.style.display = 'none';
            downloadLink.style.display = 'none';

            try {
                let finalImageToProcess = currentFile;

                // ▼ここからが追加部分: 切り抜き処理▼
                if (enableCropCheckbox.checked) {
                    const x = parseInt(cropXInput.value);
                    const y = parseInt(cropYInput.value);
                    const width = parseInt(cropWidthInput.value);
                    const height = parseInt(cropHeightInput.value);

                    if (isNaN(x) || isNaN(y) || isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                        alert('切り抜く範囲の座標とサイズを正しく入力してください。');
                        throw new Error('Invalid crop dimensions'); // エラーを発生させて処理を中断
                    }

                    // Canvasを使って画像を切り抜く
                    const croppedBlob = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, x, y, width, height, 0, 0, width, height);
                            canvas.toBlob(blob => {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('Canvas toBlob failed'));
                                }
                            }, currentFile.type || 'image/png'); // 元のファイルタイプを使用、なければPNG
                        };
                        img.onerror = () => reject(new Error('Image loading for crop failed'));
                        img.src = URL.createObjectURL(currentFile); // アップロードされた元のファイルからImageオブジェクト作成
                    });
                    finalImageToProcess = croppedBlob; // 背景除去処理には切り抜いた画像を使う

                    // 切り抜いた画像をプレビューに表示（オプション）
                    originalImagePreview.src = URL.createObjectURL(finalImageToProcess);

                }
                // ▲ここまでが追加部分: 切り抜き処理▲

                // removeBackground 関数に Blob (Fileオブジェクトまたは切り抜いたBlob) を渡す
                const blob = await removeBackground(finalImageToProcess);

                // 結果のBlobを画像として表示
                const resultUrl = URL.createObjectURL(blob);
                resultImage.src = resultUrl;
                resultImage.style.display = 'block';

                // ダウンロードリンクの設定
                downloadLink.href = resultUrl;
                downloadLink.style.display = 'block'; // または 'inline-block'

            } catch (error) {
                console.error('処理エラー:', error);
                alert('画像の処理に失敗しました。コンソールで詳細を確認してください。\nエラー: ' + error.message);
            } finally {
                loadingText.style.display = 'none';
                processImageBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
